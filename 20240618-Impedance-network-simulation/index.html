<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Background The goal here was to build some kind of metal detector that could operate at a wide range of frequencies."><title>Harry dB notes</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://Oscilllator.github.io/quartz//icon.png><link href=https://Oscilllator.github.io/quartz/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://Oscilllator.github.io/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://Oscilllator.github.io/quartz/js/darkmode.9b46d81b9b161bfac149d66dfa6b3812.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://Oscilllator.github.io/quartz/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://Oscilllator.github.io/quartz/",fetchData=Promise.all([fetch("https://Oscilllator.github.io/quartz/indices/linkIndex.cf4bce597ed1deaca322331d43bf8ecf.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://Oscilllator.github.io/quartz/indices/contentIndex.ea2743efa6b558e1b4813e954c5b1174.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://Oscilllator.github.io/quartz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://Oscilllator.github.io/quartz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/Oscilllator.github.io\/quartz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://Oscilllator.github.io/quartz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://Oscilllator.github.io/quartz/>Harry dB notes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/20240618%20Impedance%20network%20simulation.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><ol><li><a href=#why-resonate>Why resonate?</a></li><li><a href=#briefly-why-not-operate-at-different-frequencies-sequentially>Briefly: Why not operate at different frequencies sequentially?</a></li></ol></li><li><a href=#simultaneous-multi-frequency-inductors>Simultaneous multi-frequency inductors:</a><ol><li><a href=#what-would-this-look-like>What would this look like?</a></li></ol></li></ol><ol><li><a href=#code>Code</a><ol><li><a href=#network-representation>Network representation</a></li></ol></li></ol><ol><li><ol><li><a href=#bandpass-filter>Bandpass filter:</a></li></ol></li></ol><ol><li><a href=#method-1-gradient-descent>Method 1: gradient descent</a></li><li><a href=#method-2-genetic-algorithm>Method 2: Genetic algorithm</a></li><li><a href=#overnight-run>Overnight run</a></li><li><a href=#comparison-table>Comparison Table</a><ol><li><a href=#8-hour-work-run-of-more-complicated-filter>8 hour work run of more complicated filter</a></li></ol></li></ol></nav></details></aside><a href=#background><h1 id=background><span class=hanchor arialabel=Anchor># </span>Background</h1></a><p>The goal here was to build some kind of metal detector that could operate at a wide range of frequencies. Previous work <a href=/quartz/20240529-Metal-detection rel=noopener class=internal-link data-src=/quartz/20240529-Metal-detection>here</a>. It seems rather impractical/impossible(?) to make a coil that actually resonates across a decade+ frequency range of like 1-10kHz, ideally 100kHz. We want such a large frequency range because iron ore and so on has a quite different response vs frequency to gold, and so doing a full frequency sweep should provide a bunch of information.</p><a href=#why-resonate><h3 id=why-resonate><span class=hanchor arialabel=Anchor># </span>Why resonate?</h3></a><p>It&rsquo;s obviously possible to put a whole bunch of energy in a tx coil across many frequencies via some kind of class-D amplifier setup. And you could open-circuit the rx coil and measure the voltage across it too, if you wanted. But I don&rsquo;t think that that would be a good way to operate the device. Operating the coil with a capacitor in parallel as a tank circuit at the tx coil frequency is universally how metal detectors are designed, and with good reason I think. It is not so much that the tank circuit provides <em>gain</em> by resonating, but that it presents as a different impedance. It actually absorbs more of the energy in the oscillating magnetic field. So it&rsquo;s not equivalent at all to sticking a super low noise amplifier on the output of the coil.</p><a href=#briefly-why-not-operate-at-different-frequencies-sequentially><h3 id=briefly-why-not-operate-at-different-frequencies-sequentially><span class=hanchor arialabel=Anchor># </span>Briefly: Why not operate at different frequencies sequentially?</h3></a><p>You could trivially design a setup that used a switched capacitor network or tapped off the inductor to operate at different frequencies sequentially. You could then build up a picture of what is happening by scanning through the frequencies one after the other, but this would of course take a lot longer. I find this to be against the ideals of the project and refuse on that basis. When I think about what a good metal detector should be doing it is blasting the environment with as much wideband energy as it possibly can on the tx side, and using some kind of multiple coil setup to get even more information a la phased array. But since wideband seems not to be possible, perhaps N-band is.</p><a href=#simultaneous-multi-frequency-inductors><h2 id=simultaneous-multi-frequency-inductors><span class=hanchor arialabel=Anchor># </span>Simultaneous multi-frequency inductors:</h2></a><p>So one way to get this to work would be to just have a whole pile of different receive coils all operating at once. That seams infeasible though. If you look at the actual physical size of metal detector coils, they are pretty big. Big enough that stacking 10 of them together probably wouldn&rsquo;t be a super great idea. What if instead of this we could have one very large coil and then operate different subsections of it at different frequencies?</p><p>It would work something like this: Suppose you have a coil, and divide it into two sections, connected in series. The two sections together would resonate at some frequency F, and the subsection at the end would resonate at some frequency 2F. Obviously if you just hooked this up as-is, it wouldn&rsquo;t work.
But, what if you inserted a magic device in the middle? A device that let frequency F through, but blocked frequency 2F. Then the smaller section of the coil would be &lsquo;invisible&rsquo; to the larger section, and they could resonate at both frequencies at once!</p><p><img src="/quartz/Pasted image 20240628214143.png" width=auto></p><a href=#what-would-this-look-like><h3 id=what-would-this-look-like><span class=hanchor arialabel=Anchor># </span>What would this look like?</h3></a><p>Well it would look a little bit like a diplexer in the sense that different frequencies go to different places. It would actually need three ports I think, with the third port being used to attach the capacitor for the 2F resonator.</p><p>I don&rsquo;t really know how to design such a thing, but how hard could it be to simulate?</p><a href=#simulation-of-a-graph-of-rlc-networks><h1 id=simulation-of-a-graph-of-rlc-networks><span class=hanchor arialabel=Anchor># </span>Simulation of a graph of RLC networks.</h1></a><p>So we have N inductors, resistors, and capacitors connected together in a graph. And we want to calculate the impedance between the nodes as a function of frequency. The term for this is &lsquo;Nodal analysis&rsquo;, and it involves at some point constructing an &lsquo;Admittance matrix&rsquo;.</p><p>The physical layout of the system can then be described then as an adjacency matrix where the N nodes in our system are connected by resistors and capacitors. Note that for reasons I don&rsquo;t have a great intuition for, <em>ground does not count as a node</em> when doing these kinds of analyses. Instead, a connection from a node i to ground is represented as a connection with itself i.e. an element on the matrix diagonal.</p><p>If $v = ir$ and we define admittance of something to be the inverse of the resistance to be $y = 1/r$. Then $yv = i$, obviously. It transpires then that we can write our Admittance Matrix $Y$ like this:
$$YV = I$$
Where when we have N nodes Y is the NxN admittance matrix, $V$ is the Nx1 voltages of the different nodes, and $I$ is the Nx1 currents in the nodes. If we knew the currents going into and out of the nodes then, we could solve for the voltages like this:
$$V = Y^{-1}I$$
OK. This is all lecture note stuff. But recall that we don&rsquo;t have ground as an explicit node here. That means that we can stuff 1A of current into node 0 without having to have a -1A anywhere else as the current will just end up going to ground. So if we say that the input node is node 0 and we have N nodes, then $I = [1, 0, 0&mldr;0_n].T$. We know the admittance matrix, we know about <code>torch.pinv</code>, and we know what $I$ is! The system is now solveable! Yay!</p><a href=#code><h2 id=code><span class=hanchor arialabel=Anchor># </span>Code</h2></a><a href=#network-representation><h3 id=network-representation><span class=hanchor arialabel=Anchor># </span>Network representation</h3></a><p>Obviously we want to represent the graph of the network by storing the component values (like 100e-9 is a 100nF inductor). So this means that the adjacency matrix is actually a 3xNxN matrix, with the first dimension being [R, L, C]. Then for a given frequency we can calculate the impedances of the different components and put them in parallel (not sum!) across the first dimension.
It looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>calc_impedance</span><span class=p>(</span><span class=n>freq</span><span class=p>,</span> <span class=n>grid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Calculate the impedance matrix from the component grid.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    B * 3 * N * N adjacency matrix for (inductance, capactitance) for a network of N nodes.
</span></span></span><span class=line><span class=cl><span class=s2>    It is assumed that only one of the adjacency matrix edges is populated.
</span></span></span><span class=line><span class=cl><span class=s2>    Connections from a node to iself is how connections to ground are represented.
</span></span></span><span class=line><span class=cl><span class=s2>    Returns a B*N*N impedance matrix for the network.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span><span class=p>(</span><span class=n>freq</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span><span class=p>(</span><span class=n>grid</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>grid</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>B</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>N</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>grid</span><span class=o>.</span><span class=n>shape</span>
</span></span><span class=line><span class=cl>    <span class=n>j_omega</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=n>j</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=o>*</span> <span class=n>freq</span><span class=p>)</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># swap B idx for easier indexing into RLC:</span>
</span></span><span class=line><span class=cl>    <span class=n>Z_lc</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>RLC</span><span class=p>,</span> <span class=n>B</span><span class=p>,</span> <span class=n>N</span><span class=p>,</span> <span class=n>N</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>cfloat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>nonzero</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>permute</span><span class=p>(</span><span class=n>grid</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>Z_lc</span><span class=p>[</span><span class=n>R</span><span class=p>,</span> <span class=n>nonzero</span><span class=p>[</span><span class=n>R</span><span class=p>]]</span> <span class=o>=</span> <span class=n>grid</span><span class=p>[:,</span><span class=n>R</span><span class=p>][</span><span class=n>nonzero</span><span class=p>[</span><span class=n>R</span><span class=p>]]</span><span class=o>.</span><span class=n>cfloat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>Z_lc</span><span class=p>[</span><span class=n>L</span><span class=p>,</span> <span class=n>nonzero</span><span class=p>[</span><span class=n>L</span><span class=p>]]</span> <span class=o>=</span> <span class=p>(</span><span class=n>j_omega</span> <span class=o>*</span> <span class=n>grid</span><span class=p>[:,</span><span class=n>L</span><span class=p>])[</span><span class=n>nonzero</span><span class=p>[</span><span class=n>L</span><span class=p>]]</span>  <span class=c1># Reactance for inductors</span>
</span></span><span class=line><span class=cl>    <span class=n>Z_lc</span><span class=p>[</span><span class=n>C</span><span class=p>,</span> <span class=n>nonzero</span><span class=p>[</span><span class=n>C</span><span class=p>]]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>((</span><span class=n>j_omega</span> <span class=o>*</span> <span class=n>grid</span><span class=p>[:,</span><span class=n>C</span><span class=p>])[</span><span class=n>nonzero</span><span class=p>[</span><span class=n>C</span><span class=p>]])</span>  <span class=c1># Reactance for capacitors</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># sum the RLC&#39;s in parallel:</span>
</span></span><span class=line><span class=cl>    <span class=n>admittance</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>Z_lc</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>cfloat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>admittance</span><span class=p>[</span><span class=n>Z_lc</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>Z_lc</span><span class=p>[</span><span class=n>Z_lc</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>admittance</span> <span class=o>=</span> <span class=n>admittance</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Add the transpose to itself apart from the diagonal elements to make the matrix symmetric.</span>
</span></span><span class=line><span class=cl>    <span class=c1># if an impedance connects node i to node j, it should also connect node j to node i.</span>
</span></span><span class=line><span class=cl>    <span class=n>admittance_sym</span> <span class=o>=</span> <span class=n>admittance</span> <span class=o>+</span> <span class=n>torch</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=n>admittance</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>torch</span><span class=o>.</span><span class=n>eye</span><span class=p>(</span><span class=n>N</span><span class=p>)),</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Z</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>B</span><span class=p>,</span> <span class=n>N</span><span class=p>,</span> <span class=n>N</span><span class=p>),</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>cfloat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Z</span><span class=p>[</span><span class=n>admittance_sym</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>admittance_sym</span><span class=p>[</span><span class=n>admittance_sym</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Z</span>
</span></span></code></pre></td></tr></table></div></div><p>So this gives you your Z matrix from which the Y matrix can be constructed. That looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calc_voltages</span><span class=p>(</span><span class=n>Z</span><span class=p>,</span> <span class=n>I</span><span class=p>,</span> <span class=n>get_residual</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Z is B*N*N impedance matrix for the network with N nodes (not including ground).
</span></span></span><span class=line><span class=cl><span class=s2>    I is B*N length current vector for the network.
</span></span></span><span class=line><span class=cl><span class=s2>    return V, a N length voltage vector for the network.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># broadcasting for convenience:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>Z</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>Z</span> <span class=o>=</span> <span class=n>Z</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>calc_voltages</span><span class=p>(</span><span class=n>Z</span><span class=p>,</span> <span class=n>I</span><span class=p>,</span> <span class=n>get_residual</span><span class=p>)</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>I</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>I</span> <span class=o>=</span> <span class=n>I</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>calc_voltages</span><span class=p>(</span><span class=n>Z</span><span class=p>,</span> <span class=n>I</span><span class=p>,</span> <span class=n>get_residual</span><span class=p>)</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>Z</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>3</span> <span class=ow>and</span> <span class=n>I</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Y</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>Z</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>cfloat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Y</span><span class=p>[</span><span class=n>Z</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>Z</span><span class=p>[</span><span class=n>Z</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># linear components, so the matrix should be symmetric</span>
</span></span><span class=line><span class=cl>    <span class=c1># assert ((Y - torch.transpose(Y, -2, -1)).abs().sum() &lt; 1e-6).all()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Sum admittances for each node</span>
</span></span><span class=line><span class=cl>    <span class=c1># Y_diag = torch.diag(torch.sum(Y, dim=-1))</span>
</span></span><span class=line><span class=cl>    <span class=n>Y_diag</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>diag_embed</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>Y</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>),</span> <span class=n>dim1</span><span class=o>=-</span><span class=mi>2</span><span class=p>,</span> <span class=n>dim2</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Constructing the network admittance matrix correctly</span>
</span></span><span class=line><span class=cl>    <span class=n>eye_inv</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>torch</span><span class=o>.</span><span class=n>eye</span><span class=p>(</span><span class=n>Y</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]))</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>Y_network</span> <span class=o>=</span> <span class=n>Y_diag</span> <span class=o>-</span> <span class=n>Y</span> <span class=o>*</span> <span class=n>eye_inv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Solve for voltages using the network admittance matrix</span>
</span></span><span class=line><span class=cl>    <span class=n>Y_inv</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>pinv</span><span class=p>(</span><span class=n>Y_network</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Y_inv = torch.tensor(np.linalg.inv(Y_network.cpu().numpy()))</span>
</span></span><span class=line><span class=cl>    <span class=n>V</span> <span class=o>=</span> <span class=n>Y_inv</span> <span class=o>@</span> <span class=n>I</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>cfloat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>residual</span> <span class=o>=</span> <span class=p>((</span><span class=n>Y_inv</span> <span class=o>@</span> <span class=n>Y_network</span><span class=p>)</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>values</span> <span class=o>-</span> <span class=n>torch</span><span class=o>.</span><span class=n>eye</span><span class=p>(</span><span class=n>Y_network</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]))</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>residual</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Warning, bad residual! </span><span class=si>{</span><span class=n>residual</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># assert residual &lt; 0.1</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(&#34;Residual:&#34;, residual.item())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>get_residual</span><span class=p>:</span> <span class=k>return</span> <span class=n>V</span><span class=p>,</span> <span class=n>residual</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>V</span>
</span></span></code></pre></td></tr></table></div></div><a href=#example-filter><h1 id=example-filter><span class=hanchor arialabel=Anchor># </span>Example filter:</h1></a><a href=#bandpass-filter><h3 id=bandpass-filter><span class=hanchor arialabel=Anchor># </span>Bandpass filter:</h3></a><p>here is an example bandpass filter from the extremely excellent
<a href=https://markimicrowave.com/technical-resources/tools/lc-filter-design-tool/ rel=noopener>LC filter design tool</a>. I chose it as it was nice and complicated :)
<img src="/quartz/Pasted image 20240625213530.png" width=auto></p><p>This is what the internal representation looks like. Translated with ChatGPT (which got all the connections wrong):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup_inverse_chebyshev_bandpass</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>float</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>R</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>C</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mf>1.103e-6</span>   <span class=c1># C1</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>L</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mf>232.0e-6</span>   <span class=c1># L1</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>C</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mf>152.3e-9</span>   <span class=c1># C2</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>L</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mf>915.2e-6</span>   <span class=c1># L2</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>C</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>279.6e-9</span>   <span class=c1># C3</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>L</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>1.680e-3</span>   <span class=c1># L3</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>C</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>2.827e-6</span>   <span class=c1># C4</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>L</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>90.52e-6</span>   <span class=c1># L4</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>C</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=mf>85.42e-9</span>   <span class=c1># C5</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>L</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mf>2.995e-3</span>   <span class=c1># L5</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>R</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>    <span class=n>I</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>grid</span><span class=p>,</span> <span class=n>I</span>
</span></span></code></pre></td></tr></table></div></div><p>And then the results look like this:</p><p><img src="/quartz/Pasted image 20240628192701.png" width=auto></p><p>It looks very similar! The node of interest here is Node 4, the output node. But the scale seems off, this has a peak of 40dBV somehow. That&rsquo;s because the circuit is 50Ohm terminated and we pushed 1A into it.</p><a href=#optimisation><h1 id=optimisation><span class=hanchor arialabel=Anchor># </span>Optimisation</h1></a><p>Now that we have a simulation that does a fantastic job of simulating these RLC networks, we can get to work optimising one for the job at hand. Since all the code is written in pytorch, we should be able to just gradient descent our way to the correct solution, right?</p><a href=#method-1-gradient-descent><h2 id=method-1-gradient-descent><span class=hanchor arialabel=Anchor># </span>Method 1: gradient descent</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>optimise_grad_lowpass</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>grid_gt</span><span class=p>,</span> <span class=n>I_gt</span> <span class=o>=</span> <span class=n>setup_lowpass</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># frequencies = torch.logspace(torch.log10(torch.tensor(1000)), torch.log10(torch.tensor(1e6)), 1000)</span>
</span></span><span class=line><span class=cl>    <span class=n>frequencies</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mf>8e3</span><span class=p>,</span> <span class=mf>12e3</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>V_gt</span> <span class=o>=</span> <span class=n>simulate_across_freq</span><span class=p>(</span><span class=n>grid_gt</span><span class=p>,</span> <span class=n>frequencies</span><span class=p>,</span> <span class=n>I_gt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>,</span> <span class=n>I</span> <span class=o>=</span> <span class=n>setup_lowpass</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>I</span> <span class=o>=</span> <span class=n>I</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># grid[grid != 0] = torch.randn_like(grid[grid != 0])</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>grid</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span> <span class=o>*=</span> <span class=n>torch</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>grid</span><span class=p>[</span><span class=n>grid</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=o>*</span> <span class=mf>1e-2</span> <span class=o>+</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=o>.</span><span class=n>requires_grad</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>optimizer</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>optim</span><span class=o>.</span><span class=n>SGD</span><span class=p>([</span><span class=n>grid</span><span class=p>],</span> <span class=n>lr</span><span class=o>=</span><span class=mf>1e-12</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>losses</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>optimizer</span><span class=o>.</span><span class=n>zero_grad</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>V</span> <span class=p>,</span> <span class=n>residual</span> <span class=o>=</span> <span class=n>simulate_across_freq</span><span class=p>(</span><span class=n>grid</span><span class=p>,</span> <span class=n>frequencies</span><span class=p>,</span> <span class=n>I</span><span class=p>,</span> <span class=n>get_residual</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># loss = torch.mean((V - V_gt).abs())</span>
</span></span><span class=line><span class=cl>        <span class=c1># loss = torch.abs(torch.mean(1 - V.abs() / V_gt.abs())) + torch.abs(torch.mean(1 - V_gt.abs() / V.abs())) + residual * 10</span>
</span></span><span class=line><span class=cl>        <span class=n>loss</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>mean</span><span class=p>((</span><span class=n>V</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span> <span class=o>-</span> <span class=n>V_gt</span><span class=o>.</span><span class=n>abs</span><span class=p>())</span> <span class=o>**</span> <span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>V_gt</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span> <span class=o>+</span> <span class=mi>100</span> <span class=o>*</span> <span class=n>residual</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>loss</span><span class=o>.</span><span class=n>backward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>optimizer</span><span class=o>.</span><span class=n>step</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>losses</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;iter </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>, loss: </span><span class=si>{</span><span class=n>loss</span><span class=o>.</span><span class=n>item</span><span class=p>()</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>, means:</span><span class=si>{</span><span class=n>V</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>V_gt</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>, residual: </span><span class=si>{</span><span class=n>residual</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>This code absolutely refuses to converge or do anything useful. The loss blows up in two iterations with a 1e-12 learning rate. Notice that I initialized the matrix to something useful.
One thing I noticed was that the optimisation process here had a tendency to produce matrices that did not invert very well. That is, $AA^{-1} != I$. I had the brilliant idea of adding this residual to the loss function so that it would produce an invertable matrix alongside one that satisfied the other properties but that didn&rsquo;t help.</p><a href=#method-2-genetic-algorithm><h2 id=method-2-genetic-algorithm><span class=hanchor arialabel=Anchor># </span>Method 2: Genetic algorithm</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>optimise_genetic_lowpass</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>grid_gt</span><span class=p>,</span> <span class=n>I_gt</span> <span class=o>=</span> <span class=n>setup_highpass</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>Gsz</span> <span class=o>=</span> <span class=n>grid_gt</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>nf</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>    <span class=n>frequencies</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mf>7e3</span><span class=p>,</span> <span class=mf>15e3</span><span class=p>,</span> <span class=n>nf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>V_gt</span> <span class=o>=</span> <span class=n>simulate_across_freq</span><span class=p>(</span><span class=n>grid_gt</span><span class=p>,</span> <span class=n>frequencies</span><span class=p>,</span> <span class=n>I_gt</span><span class=p>)</span><span class=o>.</span><span class=n>squeeze</span><span class=p>()</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>,</span> <span class=n>I</span> <span class=o>=</span> <span class=n>grid_gt</span><span class=o>.</span><span class=n>clone</span><span class=p>(),</span> <span class=n>I_gt</span><span class=o>.</span><span class=n>clone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>gsz</span> <span class=o>=</span> <span class=n>grid</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>popsz</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=n>grid_pop</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tile</span><span class=p>(</span><span class=n>grid</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=p>[</span><span class=n>popsz</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>grid</span><span class=o>.</span><span class=n>ndim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>grid_pop</span><span class=p>[</span><span class=n>grid_pop</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>grid_pop</span><span class=p>[</span><span class=n>grid_pop</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=o>+</span> <span class=mf>0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>I_pop</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tile</span><span class=p>(</span><span class=n>I</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=p>[</span><span class=n>popsz</span><span class=p>,</span> <span class=n>nf</span><span class=p>]</span> <span class=o>+</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>I</span><span class=o>.</span><span class=n>ndim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>frequencies_pop</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tile</span><span class=p>(</span><span class=n>frequencies</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=p>[</span><span class=n>popsz</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>frequencies_flat</span> <span class=o>=</span> <span class=n>einops</span><span class=o>.</span><span class=n>rearrange</span><span class=p>(</span><span class=n>frequencies_pop</span><span class=p>,</span> <span class=s1>&#39;n f -&gt; (n f) 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>I_flat</span> <span class=o>=</span> <span class=n>einops</span><span class=o>.</span><span class=n>rearrange</span><span class=p>(</span><span class=n>I_pop</span><span class=p>,</span> <span class=s1>&#39;n f g -&gt; (n f) g&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>vis</span><span class=p>(</span><span class=n>frequencies</span><span class=p>,</span> <span class=n>V_gt</span><span class=p>,</span> <span class=n>V_meas</span><span class=p>,</span> <span class=n>grid_pop</span><span class=p>,</span> <span class=n>grid_gt</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mi>21</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>plt</span><span class=o>.</span><span class=n>subplot</span><span class=p>(</span><span class=mi>311</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>frequencies</span><span class=p>,</span> <span class=n>V_gt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>old_grids</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>errors</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>best_errors</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>grid_expanded</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tile</span><span class=p>(</span><span class=n>grid_pop</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=n>nf</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>grid_flat</span> <span class=o>=</span> <span class=n>einops</span><span class=o>.</span><span class=n>rearrange</span><span class=p>(</span><span class=n>grid_expanded</span><span class=p>,</span> <span class=s1>&#39;n f a b1 b2 -&gt; (n f) a b1 b2&#39;</span><span class=p>,</span> <span class=n>n</span><span class=o>=</span><span class=n>popsz</span><span class=p>,</span> <span class=n>f</span><span class=o>=</span><span class=n>nf</span><span class=p>,</span> <span class=n>a</span><span class=o>=</span><span class=n>RLC</span><span class=p>,</span> <span class=n>b1</span><span class=o>=</span><span class=n>gsz</span><span class=p>,</span> <span class=n>b2</span><span class=o>=</span><span class=n>gsz</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>Z</span> <span class=o>=</span> <span class=n>calc_impedance</span><span class=p>(</span><span class=n>frequencies_flat</span><span class=p>,</span> <span class=n>grid_flat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>V_meas</span> <span class=o>=</span> <span class=n>calc_voltages</span><span class=p>(</span><span class=n>Z</span><span class=p>,</span> <span class=n>I_flat</span><span class=p>)</span><span class=o>.</span><span class=n>abs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>V_pop</span> <span class=o>=</span> <span class=n>einops</span><span class=o>.</span><span class=n>rearrange</span><span class=p>(</span><span class=n>V_meas</span><span class=p>,</span> <span class=s1>&#39;(n f) g 1 -&gt; n f g&#39;</span><span class=p>,</span> <span class=n>n</span><span class=o>=</span><span class=n>popsz</span><span class=p>,</span> <span class=n>f</span><span class=o>=</span><span class=n>nf</span><span class=p>,</span> <span class=n>g</span><span class=o>=</span><span class=n>gsz</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>r1</span> <span class=o>=</span> <span class=p>(</span><span class=n>V_pop</span> <span class=o>/</span> <span class=n>V_gt</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>))</span> <span class=c1># Should be average across freq, dot against nodes we care about</span>
</span></span><span class=line><span class=cl>        <span class=n>r2</span> <span class=o>=</span> <span class=p>(</span><span class=n>V_gt</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=n>V_pop</span><span class=p>)</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=</span> <span class=p>(</span><span class=n>r1</span> <span class=o>+</span> <span class=n>r2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>argsort</span><span class=p>(</span><span class=n>error</span><span class=p>,</span> <span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>error_sorted</span> <span class=o>=</span> <span class=n>error</span><span class=p>[</span><span class=n>order</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>grid_pop</span> <span class=o>=</span> <span class=n>grid_pop</span><span class=p>[</span><span class=n>order</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>best_error</span> <span class=o>=</span> <span class=n>error_sorted</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>es</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>x</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>error_sorted</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>10</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;best error min: </span><span class=si>{</span><span class=n>error_sorted</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=si>}</span><span class=s2>, e:</span><span class=si>{</span><span class=n>es</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>frac</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=n>nkeep</span> <span class=o>=</span> <span class=n>popsz</span> <span class=o>//</span> <span class=n>frac</span><span class=p>;</span> <span class=k>assert</span> <span class=n>popsz</span> <span class=o>%</span> <span class=n>frac</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>grid_pop</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tile</span><span class=p>(</span><span class=n>grid_pop</span><span class=p>[:</span><span class=n>nkeep</span><span class=p>],</span> <span class=p>[</span><span class=n>frac</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>error_scale</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>best_error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>valid</span> <span class=o>=</span> <span class=n>grid_pop</span><span class=p>[</span><span class=n>nkeep</span><span class=p>:]</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=c1># mutation = torch.abs(torch.randn_like(grid_pop[nkeep:][valid]) * error_scale)</span>
</span></span><span class=line><span class=cl>        <span class=n>mutation</span> <span class=o>=</span> <span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>size</span><span class=o>=</span><span class=n>grid_pop</span><span class=p>[</span><span class=n>nkeep</span><span class=p>:][</span><span class=n>valid</span><span class=p>]</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span><span class=o>*</span> <span class=mf>1.5</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>)</span> <span class=o>*</span> <span class=n>error_scale</span>
</span></span><span class=line><span class=cl>        <span class=n>mask</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=n>mutation</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>        <span class=n>mutation</span><span class=p>[</span><span class=o>~</span><span class=n>mask</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>grid_pop</span><span class=p>[</span><span class=n>nkeep</span><span class=p>:][</span><span class=n>valid</span><span class=p>]</span> <span class=o>*=</span> <span class=n>mutation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>errors</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>10</span> <span class=ow>and</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>errors</span><span class=p>)[</span><span class=o>-</span><span class=mi>10</span><span class=p>:])</span> <span class=o>&lt;</span> <span class=mf>1e-5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>best_error</span> <span class=o>&lt;</span> <span class=mf>1.1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;ding&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;converged, refreshing&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>old_grids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>grid_pop</span><span class=o>.</span><span class=n>clone</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>grid_pop</span><span class=p>[</span><span class=n>grid_pop</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>10</span> <span class=o>**</span> <span class=p>(</span><span class=o>-</span><span class=mi>12</span> <span class=o>*</span> <span class=n>torch</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=n>grid_pop</span><span class=p>[</span><span class=n>grid_pop</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>errors</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=n>best_errors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>best_error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>errors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>best_error</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>This had much more success. It converged in a few seconds for an RC filter to the correct values. But, for a more complicated net like a highpass filter it kept converging to values that weren&rsquo;t very good. It seems as though it keeps getting stuck in a local minimum. So at the bottom of the loop there when I detect that the optimisation process has stopped I restart with fresh random values. It only takes a few seconds to converge so many starting points can be tested.</p><a href=#overnight-run><h2 id=overnight-run><span class=hanchor arialabel=Anchor># </span>Overnight run</h2></a><p>I did an overnight run of the highpass filter:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>setup_highpass</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>RLC</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>float</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>R</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>L</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mf>693.9e-6</span>  <span class=c1># L1</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>C</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mf>232.1e-9</span>  <span class=c1># C2</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>L</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mf>402.9e-6</span>  <span class=c1># L3</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>C</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>232.1e-9</span>  <span class=c1># C4</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>L</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mf>693.9e-6</span>  <span class=c1># L5</span>
</span></span><span class=line><span class=cl>    <span class=n>grid</span><span class=p>[</span><span class=n>R</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>    <span class=n>I</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>grid</span><span class=p>,</span> <span class=n>I</span>
</span></span></code></pre></td></tr></table></div></div><p>Which gave me this histogram of errors. Each datapoint is one run of the optimisation process, so you can see that there are a couple of discrete different losses that get converged on.</p><p><img src="/quartz/Pasted image 20240628075349.png" width=auto></p><p>It looks like there are a few runs here that converged to the right answer! The minimum error here was 1.0002.</p><a href=#comparison-table><h2 id=comparison-table><span class=hanchor arialabel=Anchor># </span>Comparison Table</h2></a><p>Here is a table of the actual grid of impedances for the ground truth and what the net managed to converge to. They are pretty much the same:</p><table><thead><tr><th>Best Convergence</th><th></th><th></th><th>Ground Truth</th><th></th><th></th></tr></thead><tbody><tr><td>Resistance</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>4.95e+01</td><td>0.00e+00</td><td>0.00e+00</td><td>5.00e+01</td><td>0.00e+00</td><td>0.00e+00</td></tr><tr><td>0.00e+00</td><td>0.00e+00</td><td>0.00e+00</td><td>0.00e+00</td><td>0.00e+00</td><td>0.00e+00</td></tr><tr><td>0.00e+00</td><td>0.00e+00</td><td>5.01e+01</td><td>0.00e+00</td><td>0.00e+00</td><td>5.00e+01</td></tr><tr><td>Inductance</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>7.23e-04</td><td>0.00e+00</td><td>0.00e+00</td><td>6.94e-04</td><td>0.00e+00</td><td>0.00e+00</td></tr><tr><td>0.00e+00</td><td>4.11e-04</td><td>0.00e+00</td><td>0.00e+00</td><td>4.03e-04</td><td>0.00e+00</td></tr><tr><td>0.00e+00</td><td>0.00e+00</td><td>7.20e-04</td><td>0.00e+00</td><td>0.00e+00</td><td>6.94e-04</td></tr><tr><td>Capacitance</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>0.00e+00</td><td>2.20e-07</td><td>0.00e+00</td><td>0.00e+00</td><td>2.32e-07</td><td>0.00e+00</td></tr><tr><td>0.00e+00</td><td>0.00e+00</td><td>2.31e-07</td><td>0.00e+00</td><td>0.00e+00</td><td>2.32e-07</td></tr><tr><td>0.00e+00</td><td>0.00e+00</td><td>0.00e+00</td><td>0.00e+00</td><td>0.00e+00</td><td>0.00e+00</td></tr></tbody></table><a href=#8-hour-work-run-of-more-complicated-filter><h3 id=8-hour-work-run-of-more-complicated-filter><span class=hanchor arialabel=Anchor># </span>8 hour work run of more complicated filter</h3></a><p>Here I tried a run over a ~10 hour workday, a much more complicated filter from <a href=/quartz/20240618-Impedance-network-simulation#bandpass-filter rel=noopener class=internal-link data-src=/quartz/20240618-Impedance-network-simulation>above</a>. That gave me this histogram of converged errors:</p><a href=#histogram-of-converged-errors><h4 id=histogram-of-converged-errors><span class=hanchor arialabel=Anchor># </span>Histogram of converged errors:</h4></a><p><img src="/quartz/Pasted image 20240628191837.png" width=auto></p><p>This one seems like a much more continuous distribution, not quite so many discrete modes. It also never converges to the right answer, with a pretty high minimum error.</p><p>This isn&rsquo;t looking so crash hot. I suppose it makes sense that this kind of landscape of L&rsquo;s an C&rsquo;s would be a minefield of local minima and that it would be difficult to converge on the global minima. I don&rsquo;t necessarily <em>need</em> the global minima for my application but the miserable failure here hardly bodes well&mldr;</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/quartz// data-ctx="20240618 Impedance network simulation.md" data-src=/ class=internal-link>Harry dB notes</a></li><li><a href=/quartz/20240618-Impedance-network-simulation/ data-ctx=above data-src=/20240618-Impedance-network-simulation class=internal-link></a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://Oscilllator.github.io/quartz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Harry dB using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2025</p><ul><li><a href=https://Oscilllator.github.io/quartz/>Home</a></li></ul></footer></div></div></body></html>