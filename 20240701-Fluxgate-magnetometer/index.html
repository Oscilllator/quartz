<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="A good introduction and guide on how to make a fluxgate magnetometer can be found in the Wireless world magazine, 1991."><title>Harry dB notes</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://Oscilllator.github.io/quartz//icon.png><link href=https://Oscilllator.github.io/quartz/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://Oscilllator.github.io/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://Oscilllator.github.io/quartz/js/darkmode.9b46d81b9b161bfac149d66dfa6b3812.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://Oscilllator.github.io/quartz/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://Oscilllator.github.io/quartz/",fetchData=Promise.all([fetch("https://Oscilllator.github.io/quartz/indices/linkIndex.b3259f812ed133e49589f69cf23d7208.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://Oscilllator.github.io/quartz/indices/contentIndex.87cbaaf98b530210f0119f4fbc380d6d.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://Oscilllator.github.io/quartz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://Oscilllator.github.io/quartz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/Oscilllator.github.io\/quartz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://Oscilllator.github.io/quartz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://Oscilllator.github.io/quartz/>Harry dB notes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/20240701%20Fluxgate%20magnetometer.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><ol><li><a href=#toroid-construction>Toroid construction</a></li><li><a href=#zero-field>Zero field</a></li><li><a href=#magazine-schematic>Magazine schematic:</a></li></ol></li><li><a href=#gating-and-filtering>Gating and filtering</a></li><li><a href=#alternative-to-gating-and-filtering>Alternative to gating and filtering</a><ol><li><a href=#amplifier>Amplifier</a></li><li><a href=#bandpass-filter>Bandpass filter</a></li></ol></li><li><a href=#using-magnetometer-to-sense-11khz-magnetic-field>Using magnetometer to sense 11kHz magnetic field.</a></li><li><a href=#measuring-technique-pivot>Measuring technique pivot.</a></li><li><a href=#more-current>More current</a></li><li><a href=#measuring-the-current>Measuring the current</a></li><li><a href=#analog-current>Analog current</a></li></ol><ol><li><a href=#test-objects>Test objects</a></li><li><a href=#measurement-technique-siglent-scpi-commands-are-garbage>Measurement technique (Siglent SCPI commands are garbage)</a></li></ol><ol><li><ol><li><a href=#time-series>Time series</a></li><li><a href=#frequency-0---modulation-khz>Frequency 0 -> modulation kHz</a></li><li><a href=#around-magnetometer-drive-frequency>Around magnetometer drive frequency</a></li><li><a href=#around-2--magnetometer-drive-frequency>Around 2 * magnetometer drive frequency</a></li></ol></li><li><a href=#cooked-measurements>Cooked measurements</a><ol><li><a href=#volts-as-a-function-of-frequency>Volts as a function of frequency</a></li><li><a href=#signal-as-a-function-of-frequency>Signal as a function of frequency</a></li></ol></li><li><a href=#hopeful-reasons-for-this-result>Hopeful reasons for this result</a></li></ol></nav></details></aside><p>A good introduction and guide on how to make a fluxgate magnetometer can be found in the
<a href=https://www.worldradiohistory.com/UK/Wireless-World/90s/Wireless-World-1991-09.pdf rel=noopener>Wireless world magazine, 1991</a>. I didn&rsquo;t really follow the guide but if you read it you&rsquo;ll get the general idea.</p><a href=#version-1><h1 id=version-1><span class=hanchor arialabel=Anchor># </span>Version 1</h1></a><p>The idea of winding a toroid sounded too hard to me so I made two separate linear coils and connected them with some magic magnetic tape. Here are the two windings before I added the sense coil:</p><p><img src="/quartz/Pasted image 20240701184124.png" width=auto></p><p>And here is what it looks like &ldquo;fully assembled&rdquo;:</p><p><img src="/quartz/Pasted image 20240701184432.png" width=auto></p><p>I drove it straight out of the signal generator and amazingly it worked out of the box. It&rsquo;s quite sensitive and was able to detect my twiddling of a bar magnet like 5 meters away!
This is quite significant as it represents the first time I have ever built an electronic device and had it (1) work on the first try and (2) had it be more sensitive than expected. I suppose it makes sense now how they were able to get them good enough in WWII to detect submarines from a plane.</p><p>The limit on the detection though was the 0 level. Even when I aligned the sensor such that it was normal to the ambient magnetic field, there was still quite a large signal measured on the scope. Reading around a bit (&ldquo;Magnetic sensors and magnetometers&rdquo; is a sensible book) it seems that one of the main reasons to use a toroid is that it evens out the variations in manufacturing that are the result of these residual errors.</p><p>Since the magnetometers measurement comes from the asymmetry in how each side of the device magnetises/demagnetises, it makes sense that this would be worth switching the design.</p><a href=#version-2><h1 id=version-2><span class=hanchor arialabel=Anchor># </span>Version 2</h1></a><p>So, time to suck it up and wind a toroid. The book also mentioned that one way to get low variation in your wound toroid is to wind it such that there windings are just touching along the inner race, since then the wire diameter is what sets the pitch. Good advice but that results in far more windings than is required in practice and I realised just after I started winding that I could have printed some notches in my 3D print which would have also defined the winding spacing and not required me to wind 7m of wire through a 35mmID toroid. Oh well.</p><a href=#toroid-construction><h3 id=toroid-construction><span class=hanchor arialabel=Anchor># </span>Toroid construction</h3></a><p>Here is the inside of the toroid. I put two strips of metal ~2.75mm wide (hand cut with scissors, naturally) into the toroid which was sized to just fit the length of the strip.
<img src="/quartz/Pasted image 20240701184920.png" width=auto></p><p>And here it is all wound together:</p><p><img src="/quartz/Pasted image 20240701185051.png" width=auto></p><p>&mldr;Not exactly a precision device, is it? But the 3d printed outer sense coil winding is critical. By rotating the inner toroid with respect to the outer one, I can move it to a point that minimizes the measurement when the sensor is perpendicular to the earths field. This makes quite a bit of difference.</p><a href=#zero-field><h3 id=zero-field><span class=hanchor arialabel=Anchor># </span>Zero field</h3></a><p>Here is the output of the sensor, showing the maximum, minimum, and zero measurements achievable here on earth:</p><p><img src="/quartz/Pasted image 20240701185559.png" width=auto></p><p>So that&rsquo;s (3.2 - -2.5) / 55e-6 = 100mV/uT. That&rsquo;s 103kV/tesla, which sounds good. That&rsquo;s also 10000 gamma/volt, and the above magazine article calibrates it to a maximum of 100 gamma/volt, or 100x more sensitive.</p><a href=#magazine-schematic><h3 id=magazine-schematic><span class=hanchor arialabel=Anchor># </span>Magazine schematic:</h3></a><p><img src="/quartz/Pasted image 20240701190306.png" width=auto></p><p><img src="/quartz/Pasted image 20240701190311.png" width=auto></p><p><img src="/quartz/Pasted image 20240701190324.png" width=auto></p><a href=#gating-and-filtering><h2 id=gating-and-filtering><span class=hanchor arialabel=Anchor># </span>Gating and filtering</h2></a><p>Here&rsquo;s an idea: The signal has 0 DC level. So what we really want to do here is rectify it. But, the signal is small. So instead we can just grab the section of the signal that has the spike in it, and average around that!</p><p>Like this:</p><p><img src="/quartz/Pasted image 20240701190754.png" width=auto></p><p>ta-da! Done using an SI2302 analog switch, aka a mosfet as recommended by the Art of Electronics:</p><p><img src="/quartz/Pasted image 20240701190843.png" width=auto></p><p>It introduces a huge amount of charge injection but I&rsquo;m going to wave my hands and say it&rsquo;s fine since the + and - section average to 0 anyway. Filtering this chopped signal and zooming into the noise floor, we get:</p><p><img src="/quartz/Pasted image 20240701193547.png" width=auto></p><p>Which sure does look an awful lot like mains. So I guess we have reached the noise floor of this particular environment.</p><a href=#alternative-to-gating-and-filtering><h2 id=alternative-to-gating-and-filtering><span class=hanchor arialabel=Anchor># </span>Alternative to gating and filtering</h2></a><p>I got annoyed at the above gating because of the charge injection that I couldn&rsquo;t get rid of. I tried adding a complementary pmos and when that didn&rsquo;t work gave up. Instead, how about rectifying the signal? It would need to be amplified first but that&rsquo;s OK as my boards with a bunch of amplifiers came in.</p><p>Here one is:</p><a href=#amplifier><h3 id=amplifier><span class=hanchor arialabel=Anchor># </span>Amplifier</h3></a><p><img src="/quartz/Pasted image 20240702204618.png" width=auto></p><p>It has a 10MHz gain bandwidth product (TP2311) so that looks about right.</p><p><img src="/quartz/Pasted image 20240702212131.png" width=auto></p><p>here is what the magnetometer looks like detecting a 1KHz sine wave:</p><p><img src="/quartz/Pasted image 20240702212010.png" width=auto></p><p>The magnetometer is being driven at 70kHz.</p><a href=#bandpass-filter><h3 id=bandpass-filter><span class=hanchor arialabel=Anchor># </span>Bandpass filter</h3></a><p><img src="/quartz/Pasted image 20240702214700.png" width=auto></p><p><img src="/quartz/Pasted image 20240702214711.png" width=auto></p><p>&mldr;Not great.</p><a href=#using-magnetometer-to-sense-11khz-magnetic-field><h2 id=using-magnetometer-to-sense-11khz-magnetic-field><span class=hanchor arialabel=Anchor># </span>Using magnetometer to sense 11kHz magnetic field.</h2></a><p>This is starting to get a bit tricky. I angled the magnetometer such that it was not receiving much magnetic field. Then I strapped a coil to it, and excited the coil at 11kHz (to fit inside the above bandpass later).</p><p>Setup:
<img src="/quartz/Pasted image 20240703082710.png" width=auto></p><p>There are three states here in the FFT plot:</p><ol><li>No excitation, minimum magnetic field. This resulted in a peak at basically only 50kHz</li><li>No excitation, max magnetic field. Strong peaks at 100 and 200kHz appear in proportion to the strength of the field</li><li>Exciting with external field. Base 11kHz modulation appears, but there is a much stronger peak at 100kHz +/- 11kHz. This is also in direct proportion to the volts going into the coil, and is also independent of the external magnetic field.
<img src="/quartz/Pasted image 20240703081957.png" width=auto></li></ol><p>I had initially thought here that the strongest signal would show up at the base excitation freqency:
<img src="/quartz/Pasted image 20240703082409.png" width=auto></p><p>But from the above FFT it appears that this is not actually the case.</p><a href=#measuring-technique-pivot><h2 id=measuring-technique-pivot><span class=hanchor arialabel=Anchor># </span>Measuring technique pivot.</h2></a><p>I gave up on all of the above amplifiers and filters, I do not think they are necessary. Instead, I can just pull 100e6 samples off the scope and do an FFT to measure the power in the bands I care about directly. I think that&rsquo;s a much better technique.</p><a href=#more-current><h2 id=more-current><span class=hanchor arialabel=Anchor># </span>More current</h2></a><p>I was barely receiving any signal at all from my magnetometer from my coil and I figure that was because I was driving it from my waveform generator rather than from a proper driver. So I resoldered the H bridge from <a href=/quartz/20240522-Plasma-toroid-4-decoupling rel=noopener class=internal-link data-src=/quartz/20240522-Plasma-toroid-4-decoupling>the plasma toroid project</a> and that pushed plenty of amps into the system. So many that I needed to put 3 5W 10R resistors in parallel so as not to hit the undervoltage lockout of the LMG chip. But after that it was fine.</p><a href=#measuring-the-current><h2 id=measuring-the-current><span class=hanchor arialabel=Anchor># </span>Measuring the current</h2></a><p>I can&rsquo;t look at the high side of the coil and use the 50R impedance of the AWG to calculate the current going into this thing any more, since this is my setup now:</p><p><img src="/quartz/Pasted image 20240704165355.png" width=auto></p><p>So I need another way to measure the current. I don&rsquo;t have any current sense resistors (4 1.1R 0603 resistors in parallel blew up real quick) but I do have a stainless steel PCB stencil, so I chopped some of that and used it as a current sense resistor:</p><p><img src="/quartz/Pasted image 20240704165623.png" width=auto></p><p>You may be wondering how one solders to stainless steel. It is in fact trivial with the tremendous flux that I was gifted. Naturally the label corroded off quite quickly and so I don&rsquo;t know what brand it is precisely, but it is inside a secondary containment container with &ldquo;STAY BRITE&rdquo; on it.</p><p>Anyway the above current sense resistor is about 0.286 Ohms apparently.</p><p>This will be required later as the coil itself has some frequency response and so you can&rsquo;t just assume the applied voltage translates to a current directly.</p><a href=#analog-current><h2 id=analog-current><span class=hanchor arialabel=Anchor># </span>Analog current</h2></a><p>Now I have things set up reasonably well I need to generate a signal at many different frequencies from my coil and measure it with the fluxgate magnetometer to prove this whole thing out. But the output of the above H bridge is always a square wave and so there will be all kinds of harmonics all over the place. I don&rsquo;t want to deal with that, I want to measure one and only one frequency at a time!</p><p>No problem though, I will use the inductor in my coil like a motor winding and drive it like a BLDC sin drive!
Here is the waveform snipped (ChatGPT was useless for this, ugh):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>generate_pwm_signal</span><span class=p>(</span><span class=n>N</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>window_size</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>N</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out_window</span> <span class=o>=</span> <span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>window_size</span> <span class=o>*</span> <span class=p>(</span><span class=n>N</span> <span class=o>//</span> <span class=n>window_size</span><span class=p>)]</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>window_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>subsize</span> <span class=o>=</span> <span class=n>out_window</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>pi</span><span class=p>,</span> <span class=n>subsize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sin</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sin_norm</span> <span class=o>=</span> <span class=p>(</span><span class=n>sin</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>sin</span><span class=p>))</span> <span class=o>/</span> <span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>sin</span><span class=p>)</span> <span class=o>-</span> <span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>sin</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>sin_norm</span> <span class=o>=</span> <span class=n>sin_norm</span> <span class=o>*</span> <span class=mf>0.8</span> <span class=o>+</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>out_window</span><span class=p>[:]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>window_size</span><span class=p>)</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>))</span> <span class=o>&lt;</span> <span class=n>sin_norm</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>remainder</span> <span class=o>=</span> <span class=n>N</span> <span class=o>-</span> <span class=n>subsize</span> <span class=o>*</span> <span class=n>window_size</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>remainder</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span><span class=p>[</span><span class=o>-</span><span class=n>remainder</span> <span class=o>//</span> <span class=mi>2</span><span class=p>:]</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>out</span>
</span></span><span class=line><span class=cl>    
</span></span></code></pre></td></tr></table></div></div><p>This can then get uploaded to the scope. This results in the following current plot:</p><p><img src="/quartz/Pasted image 20240704170558.png" width=auto></p><p>Which doesn&rsquo;t look too bad. It didn&rsquo;t replicate the low end very well so I had to do the <code>sin = sin*0.8 + 0.2</code> above. I also had to make a tradeoff with the waveform output sample rate vs number of samples in the AWG sent to the scope, since the AWG uses the same csv file (it only takes csv files over usb stick) and just plays it back faster or slower. So above a certain waveform repetition rate it goes over the AWG sample rate and the whole thing falls apart. I could transfer a new csv file per frequency but pls, that ain&rsquo;t gonna happen. The above waveform has 8192 samples and that allows it to go between 1 and 15kHz.</p><p>Now we are ready to make some measurements!</p><a href=#measurement-setup><h1 id=measurement-setup><span class=hanchor arialabel=Anchor># </span>Measurement setup</h1></a><p>The measurement setup looks like this:</p><p><img src="/quartz/Pasted image 20240704172158.png" width=auto></p><p>The idea here is that the two coils on either side are wound with the opposite circularity coil, and then placed in parallel. Per <a href=/quartz/20240529-Metal-detection#one-positive-one-negative rel=noopener class=internal-link data-src=/quartz/20240529-Metal-detection>my previous simulations</a> (and common sense) this means that there is a null in the middle where the magnetometer can be placed. The idea here is that it is similar to the double D coil setup that many other metal detectors use. The magnetometer is placed so that it is sensitive to fields in the vertical direction. There is a significant earth component in that direction too, but according to the above FFT measurements this should not affect things.</p><p>The magnetometer is hot glued to a mug so I can slide it around and get it into the right position. I do this in the time domain by just lookint at the scope and adjusting things so the persistence view shows that the amplitude is no longer being modulated. Interestingly it is not possible to zero out the field when the magnetometer is rotated 90 degrees so the donut is facing more towards the camera in the above pic (but is still vertical). I guess it&rsquo;s just too wide and either side of the toroid is affected differently.</p><a href=#test-objects><h2 id=test-objects><span class=hanchor arialabel=Anchor># </span>Test objects</h2></a><p><img src="/quartz/Pasted image 20240704172732.png" width=auto></p><p>Here are the test objects with which to make measurements. You will notice they are not exactly subtle targets. This setup is very insensitive. The point here though is to see how things <em>change</em> over frequency, not the absolute level. I shall wave my hands and say that the setup is poorly optimised overall and surely if I built it for real I could make it much more sensitive.</p><a href=#measurement-technique-siglent-scpi-commands-are-garbage><h2 id=measurement-technique-siglent-scpi-commands-are-garbage><span class=hanchor arialabel=Anchor># </span>Measurement technique (Siglent SCPI commands are garbage)</h2></a><p>The siglent scope that I have has 500Mpoints of memory. So the idea here was to use a computer to control the AWG of the scope to output the right sin drive PWM wave for the given measurement frequency. Then I could pull the waveform down to the computer again using SCPI
However:</p><ul><li>When using the SCPI command <code>C{channel}:WF? DAT2</code> to pull waveforms off the scope, if you specify any more than 10e6 waveforms you just get back 10e6, even though the acquisition may have been for 100e6 samples.</li><li>Therefore you have to save data to a USB in a mysterious binary format if you want all your samples</li><li>None of the USB SCPI commands work, they all timeout</li><li>There are no SCPI commands for controlling the waveform generator it seems
So to take a given measurement the workflow was to do the following manually:</li></ul><ol><li>Change the AWG frequency</li><li>Press &lsquo;acquire&rsquo; and wait ~15a</li><li>Save the waveform (100e6 points at 10MSa/s)</li><li>Run a script to record the metadata (which target, which frequency etc.)
Then in post I use the date modified timestamp on the oscilloscope file with the timestamp of when I ran the above script to associate the waveform data with the metadata. Disgusting.</li></ol><p>Also, the setup is quite insensitive, so I had to place the copper/ferrite targets directly on the coil right next to the mug to get a signal. This makes me a bit worried as perhaps I am blocking the field from one of the coils rather than introducing a new field from either eddy currents or distortions.</p><a href=#measurement-results><h1 id=measurement-results><span class=hanchor arialabel=Anchor># </span>Measurement results</h1></a><p>I measured three things:</p><ul><li>Copper plate</li><li>Ferrite</li><li>Nothing, but with the magnetometer offset from center slightly to get some signal
For each of these things I measured 1-15kHz in 1kHz steps which was incredibly tedious. Each measurement point here from the scopes points of view is essentially a 4*100e6 array of samples. That represents a full 10 seconds of data so there is quite a lot of averaging happening.</li></ul><p>I drove the magnetometer drive coil at 170'112Hz. I chose this rando frequency so it wouldn&rsquo;t be a multiple of any of the modulation frequencies.</p><p>Another thing of note here is that the ferrite caused a significant DC change in the measured magnetic field, which is what you would expect for something ferromagnetic. To convince myself that there would be no eddy currents here I measured the resistance of the ferrite material and it is indeed an open circuit.</p><a href=#time-series><h3 id=time-series><span class=hanchor arialabel=Anchor># </span>Time series</h3></a><p>Not much interesting here but I shall show it for completeness</p><p><img src="/quartz/Pasted image 20240705172121.png" width=auto></p><a href=#frequency-0---modulation-khz><h3 id=frequency-0---modulation-khz><span class=hanchor arialabel=Anchor># </span>Frequency 0 -> modulation kHz</h3></a><p>The below spectrograms have all been averaged with a 2Hz wide filter, as otherwise they were incredibly noisy and full of spikes.</p><p><img src="/quartz/Pasted image 20240705171740.png" width=auto></p><p>The circled parts of the green trace above are the measured currents being used to modulate the two coils. Since this is AM modulation, this apparently should show up on either side of the main drive. The reason some of the measurement above is chopped out is for plot rendering performance.</p><a href=#around-magnetometer-drive-frequency><h3 id=around-magnetometer-drive-frequency><span class=hanchor arialabel=Anchor># </span>Around magnetometer drive frequency</h3></a><p><img src="/quartz/Pasted image 20240705173307.png" width=auto></p><a href=#around-2--magnetometer-drive-frequency><h3 id=around-2--magnetometer-drive-frequency><span class=hanchor arialabel=Anchor># </span>Around 2 * magnetometer drive frequency</h3></a><p><img src="/quartz/Pasted image 20240705173453.png" width=auto></p><p>The reason that the signal from the magnetometer shows up at 2x the frequency is because fluxgate magnetometers get a pulse every time the winding magnetises and demagnetises, so you get 2 pulses per period.</p><a href=#cooked-measurements><h2 id=cooked-measurements><span class=hanchor arialabel=Anchor># </span>Cooked measurements</h2></a><p>So I get one of the above spectrograms per measurement. The next thing to do is to extract out what the magnetometer is actually measuring. To do this I just placed a 10Hz wide bandpass filter around +/- 2x the modulation frequency and called that the &lsquo;sense&rsquo; measurement, since it is the sense winding of the magnetometer.
I also put a 10Hz wide band around the measured current going through the coil, since it is possible that this also changes as a function of frequency</p><a href=#volts-as-a-function-of-frequency><h3 id=volts-as-a-function-of-frequency><span class=hanchor arialabel=Anchor># </span>Volts as a function of frequency</h3></a><p><img src="/quartz/Pasted image 20240705170107.png" width=auto></p><p>So we can see here first off that the current going through the modulation coil is pretty flat. Also all of the measurements including the control slope down with frequency. So I guess the magnetometer doesn&rsquo;t have such a flat frequency response after all.</p><p>You can also see that for the copper I took a measurement twice at 5 and 15kHz. They were both very consistent so I think this measurement has pretty good snr.</p><a href=#signal-as-a-function-of-frequency><h3 id=signal-as-a-function-of-frequency><span class=hanchor arialabel=Anchor># </span>Signal as a function of frequency</h3></a><p>Here I have divided the signal for each of the actual measured objects by the signal when there was no object, the control. The absolute signal level for the control is arbitrary and was just set by how much off-center I placed the magnetometer when making the measurement. The idea was to directly measure the magnetometers bandwidth so it could be controlled for. Since the current measurement looks flat I didn&rsquo;t bother controlling for that.</p><p><img src="/quartz/Pasted image 20240705170117.png" width=auto></p><p>&mldr;And it looks like both of them are completely flat. That is exceedingly disappointing, I was hoping the slope would look like this:</p><p><img src="/quartz/Pasted image 20240705174857.png" width=auto></p><a href=#hopeful-reasons-for-this-result><h2 id=hopeful-reasons-for-this-result><span class=hanchor arialabel=Anchor># </span>Hopeful reasons for this result</h2></a><p>It is possible though that this is still the case. It could be for two reasons that I can think of</p><ul><li>The measurement did not go low enough in frequency</li><li>Ferrite and copper do have quite a different response vs frequency but that was not what I was observing. Because the setup was so insensitive I had to place both the ferrite and the copper plate right inside basically touching the magnetic field. This could have set up an imbalance from the beginning that was much larger than the actual signal I wanted to measure.</li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/quartz// data-ctx="20240701 Fluxgate magnetometer.md" data-src=/ class=internal-link>Harry dB notes</a></li><li><a href=/quartz/202040721-magnetometer-switch/ data-ctx=before data-src=/202040721-magnetometer-switch class=internal-link></a></li><li><a href=/quartz/202040722-magnetometer-switch/ data-ctx=before data-src=/202040722-magnetometer-switch class=internal-link></a></li><li><a href=/quartz/20240722-magnetometer-switch/ data-ctx=before data-src=/20240722-magnetometer-switch class=internal-link></a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://Oscilllator.github.io/quartz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Harry dB using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2025</p><ul><li><a href=https://Oscilllator.github.io/quartz/>Home</a></li></ul></footer></div></div></body></html>