<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="In the [[20240701 Fluxgate magnetometer#Hopeful reasons for this result|previous]] episode of trying to get a fluxgate manetometer to work as a detector for a metal detector I decided that a possible reason that I didn&rsquo;t observe much of a change in signal amplitude vs frequency was that the magnetometer was not sensitive enough."><title>Harry dB notes</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://Oscilllator.github.io/quartz//icon.png><link href=https://Oscilllator.github.io/quartz/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://Oscilllator.github.io/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://Oscilllator.github.io/quartz/js/darkmode.9b46d81b9b161bfac149d66dfa6b3812.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://Oscilllator.github.io/quartz/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://Oscilllator.github.io/quartz/",fetchData=Promise.all([fetch("https://Oscilllator.github.io/quartz/indices/linkIndex.2de55b88352764bd71f394074b78b6ae.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://Oscilllator.github.io/quartz/indices/contentIndex.db757350eada4d105cdc20d7acfa86cb.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://Oscilllator.github.io/quartz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://Oscilllator.github.io/quartz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/Oscilllator.github.io\/quartz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://Oscilllator.github.io/quartz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://Oscilllator.github.io/quartz/>Harry dB notes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/20240722%20magnetometer%20switch.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#sampling-to-make-it-more-sensitive>Sampling to make it more sensitive</a></li><li><a href=#results>Results</a></li><li><a href=#wrong-circuit>Wrong circuit</a></li></ol><ol><li><a href=#schematic>Schematic</a></li><li><a href=#pcb>PCB:</a></li><li><a href=#first-results>First results:</a><ol><li><a href=#charge-injection>Charge injection</a></li><li><a href=#rtfm>RTFM</a></li><li><a href=#rise-time>Rise time.</a></li></ol></li><li><a href=#bandpass-filter>Bandpass filter</a><ol><li><a href=#1-10khz-filter>1-10kHz filter</a></li><li><a href=#filter-sensitivity-sniff-test>Filter sensitivity sniff test</a></li></ol></li><li><a href=#new-op-amp>New op amp</a></li><li><a href=#some-notes-from-debugging>Some notes from debugging</a></li></ol><ol><li><a href=#more-current-spikes>More current spikes.</a><ol><li><a href=#half-the-half-bridge>Half the half bridge:</a></li></ol></li></ol></nav></details></aside><p>In the <a href=/quartz/20240701-Fluxgate-magnetometer#hopeful-reasons-for-this-result rel=noopener class=internal-link data-src=/quartz/20240701-Fluxgate-magnetometer>previous</a> episode of trying to get a fluxgate manetometer to work as a detector for a metal detector I decided that a possible reason that I didn&rsquo;t observe much of a change in signal amplitude vs frequency was that the magnetometer was not sensitive enough. It was so insensitive that I had to wedge the copper/iron right up into the setup to measure anything:</p><p><img src="/quartz/Pasted image 20240721135309.png" width=auto></p><p>If the metal was in a more representative position I think the result might have been different.</p><a href=#sampling-to-make-it-more-sensitive><h2 id=sampling-to-make-it-more-sensitive><span class=hanchor arialabel=Anchor># </span>Sampling to make it more sensitive</h2></a><p>I <a href=/quartz/20240701-Fluxgate-magnetometer#gating-and-filtering rel=noopener class=internal-link data-src=/quartz/20240701-Fluxgate-magnetometer>already tried this</a> but my DIY analog switch had too much charge injection to be useful, so I gave up. So as a backup plan I plopped down an analog switch PCB:</p><p><img src="/quartz/Pasted image 20240721134916.png" width=auto></p><p>In the hopes that a dedicated IC would be much better. The actual part I used is the
<a href=https://www.ti.com/lit/ds/symlink/sn74lvc1g3157.pdf rel=noopener>SN74LVC1G3157</a>.</p><a href=#results><h2 id=results><span class=hanchor arialabel=Anchor># </span>Results</h2></a><p>Well, it isn&rsquo;t any better really:</p><p><img src="/quartz/Pasted image 20240721135705.png" width=auto></p><p>not only is there a huge amount of charge injection still, but there is actually quite a lot of noise turning up during the transient period, which is even worse.</p><a href=#wrong-circuit><h2 id=wrong-circuit><span class=hanchor arialabel=Anchor># </span>Wrong circuit</h2></a><p>I think I ordered the wrong part basically. What I should have done is used a sample and hold circuit rather than a analog switch.</p><a href=#new-circuit><h1 id=new-circuit><span class=hanchor arialabel=Anchor># </span>New circuit</h1></a><p>I poked about and learned of the existence of the
<a href=https://www.analog.com/media/en/technical-documentation/data-sheets/1043fa.pdf rel=noopener>LTC1043</a>. It contains a whole bunch of components and differential whatnots, but it is possible to use one corner of it to make a sample and hold circuit:</p><p><img src="/quartz/Pasted image 20240722073936.png" width=auto></p><p>Based on the immediate and totally predictable failure of the previous design I decided to put this new one in LT spice. Since this is a LT component this is actually possible:</p><p><img src="/quartz/Pasted image 20240722074120.png" width=auto></p><p>Here I have set things up so there is a sin wave signal corrupted with some spikes that we want to ignore:</p><p><img src="/quartz/Pasted image 20240722074323.png" width=auto></p><p>And here is the output from the op amp (before R6) as well as the output from the switch S2A:</p><p><img src="/quartz/Pasted image 20240722074947.png" width=auto></p><p>you can see that the output tracks the input quite well, but that the voltage sags down quite quickly outside the period where the switch is connecting the input and the output. I think that this is because the input impedance of the second op amp U3 is too high, i.e. 100kR is not enough. The idea here was that it would be a high impedance follower, but I think this might not be the proper design of op amp for that.</p><p>You can also see some spikes and whatnot going on on the input during the transition times. I think that&rsquo;s the output capacitor C2 suddenly being connected to the load of U2. Increasing the value of R6 should help fix that, although of course it forms a lowpass filter so you can&rsquo;t do it too much.</p><a href=#real-world-real-results><h1 id=real-world-real-results><span class=hanchor arialabel=Anchor># </span>Real world, real results.</h1></a><a href=#schematic><h2 id=schematic><span class=hanchor arialabel=Anchor># </span>Schematic</h2></a><p>Pretty straight forward amplifier going into a switch with an incorrectly configured buffer, followed by some more gain.</p><p><img src="/quartz/Pasted image 20240805201249.png" width=auto></p><p><img src="/quartz/Pasted image 20240805201258.png" width=auto></p><p><img src="/quartz/Pasted image 20240805201304.png" width=auto></p><a href=#pcb><h2 id=pcb><span class=hanchor arialabel=Anchor># </span>PCB:</h2></a><p>Here is the PCB:
<img src="/quartz/Pasted image 20240805201339.png" width=auto></p><a href=#first-results><h2 id=first-results><span class=hanchor arialabel=Anchor># </span>First results:</h2></a><p><img src="/quartz/Pasted image 20240805201641.png" width=auto></p><p>Looks pretty legit to me officer.</p><a href=#charge-injection><h3 id=charge-injection><span class=hanchor arialabel=Anchor># </span>Charge injection</h3></a><p>The main reason that I used this chip is that it alleges there is no charge injection when the input is around half the supply voltage:</p><p><img src="/quartz/Pasted image 20240805201752.png" width=auto></p><p>which means that for signals with 0 amplitude you should be all G.</p><p><img src="/quartz/Pasted image 20240805202213.png" width=auto></p><p>&mldr;this is interesting. Here I have zoomed in on one section. You can see that when the signal is switched there is indeed no charge injection. But when the signal is switched away, the signal starts to decay since there isn&rsquo;t anything attached to that node of the circuit anymore. That&rsquo;s obviously something that needs to be fixed. It should either hold its previous value (best) or decay to vcc/2 instead of GND. I wonder if it&rsquo;s the lack of capacitance on the output combined with the input bias current of the op amp I am using&mldr;</p><a href=#rtfm><h3 id=rtfm><span class=hanchor arialabel=Anchor># </span>RTFM</h3></a><p>Here is the schematic for sample and hold from the datasheet:</p><p><img src="/quartz/Pasted image 20240805202514.png" width=auto></p><p>&mldr;yeah. time to put 1nF on the output of my switch.</p><p><img src="/quartz/Pasted image 20240805203113.png" width=auto></p><p>Nice! Now the droop has gone from like 200mV to 2mV. That&rsquo;s pretty good. But if my signal is in the nV/uV range, that is still not close to good enough!</p><a href=#rise-time><h3 id=rise-time><span class=hanchor arialabel=Anchor># </span>Rise time.</h3></a><p>Here is the rise time with the 1nF cap attached:</p><p><img src="/quartz/Pasted image 20240805203949.png" width=auto></p><p>Recall from <a href=/quartz/20240701-Fluxgate-magnetometer#gating-and-filtering rel=noopener class=internal-link data-src=/quartz/20240701-Fluxgate-magnetometer>before</a> that the total width of our pulse was around 2uS. You can see from above already that the rise time of the signal is about, or just under, 2uS. So that&rsquo;s not good, it would be nice if it was 2-10x faster.</p><p>Here is what the datasheet has to say on the topic:</p><p><img src="/quartz/Pasted image 20240805204444.png" width=auto></p><p>So we need Ron:</p><p><img src="/quartz/Pasted image 20240805204534.png" width=auto></p><p>240*1e-9 = 240ns. But our rise time is like 10x 240ns! I don&rsquo;t know why this is. In the above scope trace you can see a blip in the blue input as the control line is switched. That&rsquo;s the impact of the scope impedance, which is clearly not a significant factor. I think maybe I need an op amp with a much lower input bias current.</p><p>While those are coming in the mail, I figured I would proceed regardless. The circuit should still work, it will just be less effective.</p><a href=#bandpass-filter><h2 id=bandpass-filter><span class=hanchor arialabel=Anchor># </span>Bandpass filter</h2></a><p>With all of the above working the circuit is definitely much more sensitive, it saturates with a small fraction of the earths magnetic field so I have been &ldquo;nulling&rdquo; the sensor by placing a magnet at the right distance and orientation so it measures 0 field in total. Then the signal that I get is dominated by mains hum at the low end and the 200+kHz pulses at the high end. Time for a filter:</p><p><img src="/quartz/Pasted image 20240807214122.png" width=auto></p><p>My inductor kit just arrived in the mail so this is a good test. This is what the above kit looks like when constructed out of rando components:</p><p><img src="/quartz/Pasted image 20240808075128.png" width=auto></p><p><img src="/quartz/Pasted image 20240807214240.png" width=auto>
&mldr;not great. I suspect that the fact that my 15mH inductors have themselve 50R of DC resistance is not helping matters. It seems to be failing most at the high end though. I feel like that would be mostly due to self resonance of L2 being too low.</p><p>Changing the filter to 1kHz->10kHz would give more time for an imperfect rolloff to attenuate the ~1MHz pulses from the magnetometer, but that would also involve changing the top inductor to 220uH:</p><p><img src="/quartz/Pasted image 20240808074724.png" width=auto></p><p>which would lower the SRF and make the performance of the filter <em>worse</em> at the high end. So I am hesitant to spend some time building one. The inductor sheet does not seem to come with a datasheet (hah) but when I filter digikey inductors from ones with the same inductance and similar DCR they all have SRF&rsquo;s in the MHz range. So maybe I&rsquo;m fine.</p><a href=#1-10khz-filter><h3 id=1-10khz-filter><span class=hanchor arialabel=Anchor># </span>1-10kHz filter</h3></a><p><img src="/quartz/Pasted image 20240808184121.png" width=auto></p><p><img src="/quartz/Pasted image 20240808184131.png" width=auto></p><p>That looks much better!</p><a href=#filter-sensitivity-sniff-test><h3 id=filter-sensitivity-sniff-test><span class=hanchor arialabel=Anchor># </span>Filter sensitivity sniff test</h3></a><p>Green here is the filtered result, blue is the unfiltered:</p><p><img src="/quartz/Pasted image 20240809074104.png" width=auto></p><p>This looks pretty good. Now that the new op amp has arrived, it&rsquo;s time to go back and put that in I think.</p><a href=#new-op-amp><h2 id=new-op-amp><span class=hanchor arialabel=Anchor># </span>New op amp</h2></a><p>I switched out the op amp that is the buffer on the output of the analog switch for the new OPA2392, with 10fA(!) of input bias current. This should allow me to use a significantly lower storage capacitor on the output of the switch, since it won&rsquo;t be drained by the capacitor. I changed the cap from 1nF to 270pF and got this:</p><p><img src="/quartz/Pasted image 20240809081425.png" width=auto></p><p>In the <a href=/quartz/20240722-magnetometer-switch#rise-time. rel=noopener class=internal-link data-src=/quartz/20240722-magnetometer-switch>previous</a> section the rise time was 1us, which was not comfortably within the sampling window. Here it is like 200ns, so you can see the output begin to track the input even within the sampling window. Noice!</p><p>Here is another view zoomed out showing the wonderful sample and hold behavior on a test sawtooth waveform:</p><p><img src="/quartz/Pasted image 20240809210532.png" width=auto></p><a href=#some-notes-from-debugging><h2 id=some-notes-from-debugging><span class=hanchor arialabel=Anchor># </span>Some notes from debugging</h2></a><p>Putting the above filter on the output of the OPA2392 results in some absolutely disgusting waveforms. This isn&rsquo;t a surprise, since it is not specced at all to drive a 50R load. This led to a little confusion since the NE5532 also isn&rsquo;t specced for this, but does not seem to have any pathological behavior if you do. Fortunately, I had a spare op amp output on my board already, so hooking that up as a buffer allowed me to pipe the output into the filter as intended:</p><p><img src="/quartz/Pasted image 20240810111642.png" width=auto></p><p>One other thing: I noticed that the output was only nonsaturated for a very narrow range of magnetic fields. I took this to be because of the super high gain, and indeed this is the case, but the situation can be made much much better by AC coupling after the buffer:</p><p><img src="/quartz/Pasted image 20240810111753.png" width=auto></p><p>since then the DC earth magnetic field does not contribute to the saturation, only the AC component from my drive coil.</p><p>Her is the output after making the above changes before and after the filter:</p><p><img src="/quartz/Pasted image 20240810111928.png" width=auto></p><p>grrr. Previously the mains interference was sinusoidal, like all honest mains interference is. But here there is a square wave mains interference, so after filtering the edges still come through loud and clear. How annoying.</p><a href=#sensitivity-comparison><h1 id=sensitivity-comparison><span class=hanchor arialabel=Anchor># </span>Sensitivity comparison</h1></a><p>Throughout all of this there has been some kind of assumption that the sensitivity of the magnetometer was somewhere near that of a coil I have been using a coil to compare, and indeed the magnitude of the signal is comparable. But, I have not been using a coil with an appropriate capacitor to make the coil into an LC resonator. The comparison here is easy since I can directly swap out the magnetometer pickup coil for a coil of the same type as what I have been using as a drive coil.</p><p>Here we shall compare a 454uH pickup coil tuned to 8.5kHz with two 470nF caps in parallel. with the drive and pickup coils separated by about 1m, the coil has 200mVpp of signal, and when I zoom in a bunch it has about 2mVpp of noise. Here is an FFT of the noise:</p><p><img src="/quartz/Pasted image 20240810120149.png" width=auto></p><p>When I connect the magnetometer across the input again (after desoldering the caps) the signal has a magnitude of 20mVpp, and the noise has a magnitude of 4mVpp (after taking out the spikes coming in from the mains noise). Here is a spectrum coming from the magnetometer:</p><p><img src="/quartz/Pasted image 20240810120726.png" width=auto></p><p>lots of disgusting spikes there. Regardless it looks like the main difference here is the sensitivity rather than the noise. I think I can chalk up the lower noise of the pickup coil to the lower bandwidth of the LC resonator. The reduced signal though is another matter. I suspect that the cause of this is that the &ldquo;loop area&rdquo; of the magnetometer is quite a bit lower than the coil, since the coil has a diameter of around 200mm and the magnetometer is only around 40mm.</p><p>The question is though what defines the &rsquo;loop area&rsquo;. You might think that it is the loop area of the pickup coil, but I do not think that this is the case since the purpose of that coil is just to pick up when the main magnetometer material saturates. Perhaps then it is the total amount of flux concentration that the magnetic material in the magnetometer manages. This sounds like a job for a textbook though.</p><p>&ldquo;Magnetic sensors and magnetometers&rdquo; has this to say on the topic of noise:</p><p><img src="/quartz/Pasted image 20240810122119.png" width=auto>
<img src="/quartz/Pasted image 20240810122321.png" width=auto></p><p><img src="/quartz/Pasted image 20240810122339.png" width=auto></p><p>So it looks like changing the size of the sensor is futile. But one thing could easily be changed: I have been using a 50R impedance waveform generator with a 20V signal to power the drive coil. It sounds like I should change that to something else.</p><p>Actually:</p><p><img src="/quartz/Pasted image 20240810150445.png" width=auto></p><p>So maybe there is something to building a large sensor!.</p><a href=#more-current-spikes><h2 id=more-current-spikes><span class=hanchor arialabel=Anchor># </span>More current spikes.</h2></a><p>Another thing to do is drive the drive coil harder. I&rsquo;m going to add a cap in series with the output of my H bridge in an identical topology to the <a href=/quartz/20240522-Plasma-toroid-4-decoupling rel=noopener class=internal-link data-src=/quartz/20240522-Plasma-toroid-4-decoupling>20240522 Plasma toroid 4 decoupling</a>.</p><p>I have no idea what the inductance of the drive coil is and given that it depends on the amplitude of the signal due to the saturation of the coil I&rsquo;m just going to start with 10uF and go from there.</p><p>10uF looks like this:</p><p><img src="/quartz/Pasted image 20240810184702.png" width=auto></p><p>which is a period of around 400ns.
This is what it looks like with 100nF:</p><p><img src="/quartz/Pasted image 20240810190442.png" width=auto></p><p>&mldr;I have never seen a more square resonance in my life. Down to 100pF!</p><p><img src="/quartz/Pasted image 20240810190751.png" width=auto></p><p>&mldr;too far. 2nF looks like this:</p><p><img src="/quartz/Pasted image 20240810191511.png" width=auto></p><p>I think what&rsquo;s going on here is that the Q is suuper low because of the energy losses in the switching. The reason that I am even trying this resonant mode is because a single half bridge is one sided, so it can&rsquo;t saturate the coil in both directions. Just to sanity check, this is what it looks like when I drive the coil with no capacitor, just the half bridge switching node to ground:</p><p><img src="/quartz/Pasted image 20240810191915.png" width=auto></p><a href=#half-the-half-bridge><h3 id=half-the-half-bridge><span class=hanchor arialabel=Anchor># </span>Half the half bridge:</h3></a><p>Instead of having the coil go to ground, how about this:</p><p><img src="/quartz/Pasted image 20240810212446.png" width=auto>
Now it can sink and source current! Never mind about the 20 ohms to ground, this ain&rsquo;t an efficiency competition. This actually works quite well. Even when switching the coil current the voltage at the midpoint stays flat with 20uF of decoupling. However the output still goes all unstable at higher than 70kHz, just like with all of the above capacitor resonant setups:</p><p><img src="/quartz/Pasted image 20240810212809.png" width=auto></p><p>This is what the output looks like at a lower frequency of 14 kHz</p><p><img src="/quartz/Pasted image 20240810213312.png" width=auto></p><p>And here is the highest stable frequency:</p><p><img src="/quartz/Pasted image 20240810213551.png" width=auto></p><p>It seems pretty clear here that the reason the output goes all unstable at a higher frequency than this is because the hysteresis curve hasn&rsquo;t gotten all the way back to the beginning, so &ldquo;isn&rsquo;t ready&rdquo; for a new cycle to begin. From before we could see that the duration of the spike got shorter with higher di/dt, so you would think that just cranking up the supply voltage would do the trick here. It doesn&rsquo;t though. Here is a picture that illustrates this shortening:</p><p><img src="/quartz/Pasted image 20240810214011.png" width=auto></p><p>You can clearly see that at 20V supply there is loads of time between impulses. And yet, the maximum frequency that the circuit can be operated at stably is exactly the same - 73kHz. So how was I able to operate it at 200kHz with the waveform generator before? Time to plug that back in. Here is the AWG hooked up with a 20V amplitude square wave:</p><p><img src="/quartz/Pasted image 20240810214723.png" width=auto></p><p>This is a 50R output so it shows clearly the magnetometer getting its core charged up, during which it has a high inductance and there is some imbalance in the coil, followed by the saturation of the core and the collapse of the voltage across the drive coil down to 0 as the resistance becomes equal to the few mOhm of DC coil resistance.</p><p>Here it is operating at 200kHz:</p><p><img src="/quartz/Pasted image 20240810214953.png" width=auto></p><p>Perfectly stable. Why is that? I don&rsquo;t really know. Thinking about the above paragraph though, maybe if I put some series resistance in with the coil like the waveform generator has I would prevent the instability. But at that point I would be just like the waveform generator! The whole idea here was that by driving it directly from the half bridge the core would saturate faster, and I would get a shorter higher amplitude peak that would be an overall better SNR. That doesn&rsquo;t seem to have been the case though, so I think it&rsquo;s safe to give up here. Probably a better core material is required.</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/quartz// data-ctx="20240722 magnetometer switch.md" data-src=/ class=internal-link>Harry dB notes</a></li><li><a href=/quartz/20240722-magnetometer-switch/ data-ctx=previous data-src=/20240722-magnetometer-switch class=internal-link></a></li><li><a href=/quartz/20240811-BH-curves/ data-ctx=previously data-src=/20240811-BH-curves class=internal-link></a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://Oscilllator.github.io/quartz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Harry dB using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2025</p><ul><li><a href=https://Oscilllator.github.io/quartz/>Home</a></li></ul></footer></div></div></body></html>