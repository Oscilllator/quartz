<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Measuring frequency response 2k resistor on the output of the phase detecor and it&rsquo;s associated frequency response. the 2k resistor more or less removed the phase shift from before"><title>Harry dB notes</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://Oscilllator.github.io/quartz//icon.png><link href=https://Oscilllator.github.io/quartz/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://Oscilllator.github.io/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://Oscilllator.github.io/quartz/js/darkmode.9b46d81b9b161bfac149d66dfa6b3812.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://Oscilllator.github.io/quartz/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://Oscilllator.github.io/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://Oscilllator.github.io/quartz/",fetchData=Promise.all([fetch("https://Oscilllator.github.io/quartz/indices/linkIndex.5c0e17b8c261bcfdb15812c925c750ce.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://Oscilllator.github.io/quartz/indices/contentIndex.eea646b3e8f6abc4d69cafe0a5fdc63c.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://Oscilllator.github.io/quartz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://Oscilllator.github.io/quartz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/Oscilllator.github.io\/quartz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://Oscilllator.github.io/quartz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://Oscilllator.github.io/quartz/>Harry dB notes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><p class=meta>Last updated
Unknown
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/20220301%20fm%20-%20Loop%20the%20loop.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><ol><li><a href=#measuring-frequency-response>Measuring frequency response</a></li><li><a href=#designing-a-loop-filter>&ldquo;Designing&rdquo; a loop filter</a></li></ol></li></ol><ol><li><a href=#group-delay-aka-latency-aka-the-devil>Group delay aka latency aka the devil</a></li><li><a href=#bandwidth>Bandwidth</a><ol><li><a href=#ac-coupling>AC coupling</a></li><li><a href=#gain>Gain</a></li></ol></li></ol></nav></details></aside><a href=#measuring-frequency-response><h3 id=measuring-frequency-response><span class=hanchor arialabel=Anchor># </span>Measuring frequency response</h3></a><p>2k resistor on the output of the phase detecor and it&rsquo;s associated frequency response. the 2k resistor more or less removed the phase shift from before</p><p>This is with no inverter, loop closed.
Looks like the frequency response of the VCO isn&rsquo;t really good enough here.</p><p><img src="/quartz/Pasted image 20220301194118.png" width=auto></p><p>here is a scope trace of when the loop is closed with a switch. You can see that the applied volts initially goes crazy and the vco can&rsquo;t keep up:</p><p><img src="/quartz/Pasted image 20220301202336.png" width=auto></p><a href=#designing-a-loop-filter><h3 id=designing-a-loop-filter><span class=hanchor arialabel=Anchor># </span>&ldquo;Designing&rdquo; a loop filter</h3></a><p>I think maybe one of the problems is just not enough bandwidth in the loop. Perhaps you need way more gain and bandwidth than you think, like an op amp. Tried to do a brick wall filter at 1MHz using the online filter tool:</p><p><img src="/quartz/Pasted image 20220306204049.png" width=auto></p><p>But to get reasonable inductance values I needed to set the impedance to 1R.
This resulted in a 3dB bandwidth of like 20kHz when using a 50R output impedance on the AWG. Wonder why that is&mldr;. Perhaps using the large discrete inductors is warranted.</p><p>Adjusting for a 50R input and output impedance results in some still-plausible inductance values:</p><p><img src="/quartz/Pasted image 20220307205624.png" width=auto></p><p>An LT spice simulation with actual component values seemed to think that things would also be OK:</p><p><img src="/quartz/Pasted image 20220307205715.png" width=auto></p><p><img src="/quartz/Pasted image 20220307205729.png" width=auto></p><p><a class="internal-link broken">Draft1.asc</a>
&mldr;and the oscilloscope seems to agree!
I think this is the best plausible loop filter I can make right now, and I would hope is good enough.
Pic of the filter:</p><p><img src="/quartz/Pasted image 20220322191914.png" width=auto></p><a href=#thoughts-on-loop-filter-required-bandwidth><h1 id=thoughts-on-loop-filter-required-bandwidth><span class=hanchor arialabel=Anchor># </span>Thoughts on loop filter required bandwidth:</h1></a><a href=#group-delay-aka-latency-aka-the-devil><h2 id=group-delay-aka-latency-aka-the-devil><span class=hanchor arialabel=Anchor># </span>Group delay aka latency aka the devil</h2></a><p>Let&rsquo;s say that the max difference in freq we want to deal with is 1MHz, and the output of the phase detector is 100mV.
So the sin wave phase signal inverts itself every quarter wave, or 1/1Mhz * 1/4 = 250us. We want to be <em>comfortably</em> within that range (10%?) so let&rsquo;s says that the group delay of the filter needs to be below 25us over the bandwidth we are interested in, otherwise the control voltage that&rsquo;s supposed to be correcting the phase back to zero won&rsquo;t arrive in time and the phase will have inverted by then:</p><p><img src="/quartz/Pasted image 20220307210531.png" width=auto></p><p>According to LT spice the 4th order elliptical filter has a flat 0.4us group delay all the way out to 500KHz.
#TODO: measure the group delay of the circuit.</p><a href=#bandwidth><h2 id=bandwidth><span class=hanchor arialabel=Anchor># </span>Bandwidth</h2></a><p>This one is easy. We should just have a 3dB bandwidth that&rsquo;s high enough. According to LT spice this one is good out to like a MHz but a quick scope measurement with the AWG seems to say that 500KHz is closer to the mark. This should still be good enough.</p><p>I think we might need more gain though. If you think about it if the maximum control voltage needs to be applied in order to correct the phase, then <em>a phase shift of 180deg</em> needs to be applied to correct the phase, since the correction comes from the error itself. Put like that, a pissant 100mV output from the IF aint gonna cut it. We&rsquo;re gonna need a proper amplifier!</p><a href=#ac-coupling><h3 id=ac-coupling><span class=hanchor arialabel=Anchor># </span>AC coupling</h3></a><p>The LO and the RF signal are not going to be perfectly matched in frequency. So some constant DC offset is going to have to be provide to the VCO to make it match frequencies. That means all of the loop filters etc etc need to be <em>dc coupled</em> which they haven&rsquo;t been so far (silly me). The art of electronics suggests using a differential amplifier as a DC coupled alternative to the common-emmitter amplifier.</p><a href=#gain><h3 id=gain><span class=hanchor arialabel=Anchor># </span>Gain</h3></a><p>I should measure how many MHz/V the VCO is and then calculate the required gain of the amplifier so that only a phase error of say 1/100 of a wavelength is required in order to generate enough voltage to correct the signal.
So if the VCO is 1MHz/v (not too far off) and the IF output is 100mV, and then we want the full scale output voltage of the phase detector to be pretty big, prolly like 10V.</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/quartz// data-ctx="20220301 fm - Loop the loop.md" data-src=/ class=internal-link>Harry dB notes</a></li><li><a href=/quartz/20220322-Look-at-that-Bode/ data-ctx="20220301 fm - Loop the loop#Designing a loop filter" data-src=/20220322-Look-at-that-Bode class=internal-link></a></li><li><a href=/quartz/20220617-XOR/ data-ctx="20220301 fm - Loop the loop#Designing a loop filter" data-src=/20220617-XOR class=internal-link></a></li><li><a href=/quartz/index_base/ data-ctx="20220301 fm - Loop the loop.md" data-src=/index_base class=internal-link>Harry dB notes</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://Oscilllator.github.io/quartz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Harry dB using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2025</p><ul><li><a href=https://Oscilllator.github.io/quartz/>Home</a></li></ul></footer></div></div></body></html>